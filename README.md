# WPS 表格合并工具

一个基于 WPS COM 接口的 Excel/WPS 表格文件批量合并工具，能够将指定文件夹中的所有工作表合并到单个文件中，并保留复杂工作表中所有内容（包含但不仅限于：公式，图片，宏等）

## 📋 功能特性

- ✅ **批量合并**：自动扫描文件夹中的所有 `.xls`、`.xlsx`、`.xlsm` 文件
- ✅ **智能命名**：工作表自动重命名为 `原文件名_原工作表名` 格式
- ✅ **进程清理**：自动清理后台残留的 WPS/Excel 进程，避免冲突
- ✅ **容错处理**：多级保存策略，确保文件成功保存
- ✅ **只读模式**：源文件以只读方式打开，避免意外修改
- ✅ **自动过滤**：自动跳过临时文件（`~$` 开头）和输出文件本身

## 🔧 环境要求

- **操作系统**：Windows
- **Python 版本**：3.6+
- **依赖库**：
  - `pywin32` - Windows COM 接口支持
- **软件要求**：已安装 WPS Office（支持 `Ket.Application` 或 `Et.Application`）

## 📦 安装

### 1. 安装 Python 依赖

```bash
pip install pywin32
```

### 2. 确保 WPS Office 已安装

工具需要调用 WPS 的 COM 接口，请确保系统已安装 WPS Office。

## 🚀 使用方法

### 基本用法

1. **修改配置**：在 `WPS combiner.py` 文件末尾修改以下参数：

```python
if __name__ == "__main__":
    # 方式一：使用绝对路径
    # FOLDER = r"D:\Work\xxx"
    
    # 方式二：使用相对路径（推荐）
    SCRIPT_DIR = Path(__file__).parent.resolve()
    FOLDER = str(SCRIPT_DIR / "测试")  # 源文件夹路径（相对于脚本所在目录）
    
    OUTPUT_NAME = "最终合并版_WPS专用.xls"  # 输出文件名
```

2. **运行脚本**：

```bash
python "WPS combiner.py"
```

### 函数调用方式

你也可以在代码中直接调用函数：

```python
from pathlib import Path
from wps_combiner import merge_wps_fix_save

# 指定源文件夹和输出文件名
# 方式一：使用绝对路径
# source_folder = r"D:\Work\xxx"

# 方式二：使用相对路径（推荐）
script_dir = Path(__file__).parent.resolve()
source_folder = str(script_dir / "测试")

output_filename = "最终合并版_WPS专用.xls"

merge_wps_fix_save(source_folder, output_filename)
```

## 📖 工作原理

1. **环境清理**：强制终止可能残留的 WPS/Excel 进程
2. **启动 WPS**：通过 COM 接口启动 WPS 表格应用（不可见模式）
3. **文件扫描**：扫描指定文件夹，过滤出有效的表格文件
4. **工作表复制**：逐个打开文件，将所有工作表复制到目标工作簿
5. **智能命名**：工作表重命名为 `文件名_原工作表名`（最长 30 字符）
6. **保存文件**：使用多级保存策略确保文件成功保存为 `.xls` 格式
7. **资源清理**：关闭所有工作簿，退出 WPS，清理进程

## ⚙️ 技术细节

### 保存策略

工具采用三级保存策略，确保在各种情况下都能成功保存：

- **方案 A**：使用 `SaveAs` 指定格式 56（Excel 97-2003 格式）
- **方案 B**：使用 `SaveAs` 不指定格式，让 WPS 根据后缀名自动识别
- **方案 C**：使用 `SaveCopyAs` 另存副本（最稳妥的方式）

### 工作表命名规则

- 格式：`原文件名_原工作表名`
- 最大长度：30 字符（Excel/WPS 工作表名称限制）
- 自动截断：超过长度限制时自动截断

### 文件过滤规则

自动跳过以下文件：
- 临时文件：以 `~$` 开头的文件
- 输出文件：与输出文件名相同的文件
- 非表格文件：不是 `.xls`、`.xlsx`、`.xlsm` 格式的文件

## ⚠️ 注意事项

1. **文件格式**：输出文件使用 `.xls` 格式（Excel 97-2003），以获得最佳 WPS 兼容性
2. **文件占用**：运行前请确保源文件夹中的文件未被其他程序打开
3. **进程清理**：工具会自动清理后台进程，可能会关闭正在运行的 WPS/Excel
4. **工作表数量**：合并后的工作表数量取决于源文件数量，请确保不超过 Excel/WPS 的限制
5. **路径问题**：支持绝对路径和相对路径两种方式，推荐使用相对路径（基于脚本所在目录）

## 🐛 常见问题

### Q: 提示"无法启动 WPS，请检查安装"
**A**: 请确保已安装 WPS Office，并且 COM 接口可用。可以尝试重新安装 WPS Office。

### Q: 保存失败
**A**: 检查输出文件路径是否有写入权限，以及磁盘空间是否充足。工具会自动尝试多种保存方式。

### Q: 某些文件被跳过
**A**: 检查文件是否损坏，或者是否被其他程序占用。工具会输出跳过的文件名和原因。

### Q: 工作表名称被截断
**A**: 这是正常现象，Excel/WPS 工作表名称最长 30 字符，超过会自动截断。

## 📝 更新日志

### v1.0
- 初始版本
- 支持批量合并 Excel/WPS 文件
- 多级保存策略
- 自动进程清理

## 📄 许可证

本项目采用 MIT 许可证。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请通过 GitHub Issues 联系。

---

**注意**：本工具仅适用于 Windows 系统，需要安装 WPS Office 和 Python 环境。
